<!DOCTYPE html>
<html>
<head>
    <title>{{ data.title }}</title>
    {% include 'includes.html' %}
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/main.css') }}">

    <!--LOAD PRE-REQUISITES FOR GOOGLE SIGN IN -->
    <meta name="google-signin-scope" content="profile email">
    <meta name="google-signin-client_id"
          content="{{ data.client_id }}">
    <!-- END PRE-REQUISITES FOR GOOGLE SIGN IN -->
</head>
<body>
{% include 'top.html' %}
<div>&nbsp;</div>
<div class="container">
    <div class="row table-light">
        <div class="col-1">
        </div>
        <div class="col-7">
            <form action="login" method="post">

                <div>&nbsp;</div>
                <div class="row">
                    <div class="col-3">
                        <div class="row p-1 font-weight-bolder themed-grid-col">Username:</div>
                    </div>
                    <div class="col-8">
                        <input type="text" name="user_name" value="{{ data.user_name }}"/>
                    </div>
                </div>

                <div class="row">
                    <div class="col-3">
                        <div class="row p-1 font-weight-bolder themed-grid-col">Password:</div>
                    </div>
                    <div class="col-8">
                        <input type="password" name="user_password" value="{{ data.user_password }}"/>
                    </div>
                </div>

                <div class="row">
                    <div class="col-3">
                        <button class="btn btn-primary" role="button" type="submit">Login</button>
                    </div>
                    <div class="col-3 g-signin2" data-longtitle="true" data-theme="dark" id="signinButton">
{#                        &nbsp;<button class="btn" >Google Sign-In</button>#}
                    </div>

{#                    <div class="g-signin2 col-3" data-longtitle="true" id="signinButton"></div>#}

                </div>
                {#            <input type="hidden" name="item_id" value="{{ result.item.id }}"/>#}
            </form>
        </div>
    </div>
    <a href='#' onclick='return signOut()'>Sign Out from Google <a/>
</div>
{% include 'footer.html' %}
<!--NEW GOOGLE SIGN IN CODE -->
</body>
<script type="application/javascript">

    var auth2;

    function init() {
        gapi.load('auth2', function () {
            console.log("loaded auth2")
            auth2 = gapi.auth2.init({
                client_id: '{{ data.client_id }}',
                scope: 'profile email'
            });

            $("#signinButton").click(function () {
                console.log("clicked")
                auth2.grantOfflineAccess({
                    'redirect_uri': 'postmessage'
                }).then(offlineAccess);
            });

            // https://stackoverflow.com/a/50948753
            setTimeout(function () {
                $('#signinButton div div div span span:last').text("hello");
                $('#signinButton div div div span span:first').text("hello");
            }, 3000);
        });
    }

    function signIn() {
        auth2.grantOfflineAccess({
            'redirect_uri': 'postmessage'
        }).then(offlineAccess);
    }

    function offlineAccess(resp) {
        console.log("in offline access");
        var auth_code = resp.code;
        console.log(resp);

        $.ajax({
            type: "POST",
            url: "/oauth/google", // {{url_for('login')}}",
            processData: false,
            contentType: 'application/octet-stream; charset=utf-8',
            data: auth_code,
            success: function (result) {
                $("body").html(result);
                setTimeout(function () {
                    window.location.href = '/'
                }, 3000);
            }
        });
    }

    function signOut() {
        auth2.signOut().then(
            function () {
                console.log('signOut called');

                $.ajax({
                    type: "POST",
                    url: "{{url_for('logout')}}",
                    processData: false,
                    contentType: 'application/octet-stream; charset=utf-8',
                    success: function (result) {
                        $("body").html(result);
                        setTimeout(function () {
                            window.location.href = '/'
                        }, 3000);
                    }
                });
            }
        )
    }

</script>

{#  <script>#}
{#    function onSuccess(googleUser) {#}
{#      console.log('Logged in as: ' + googleUser.getBasicProfile().getName());#}
{#    }#}
{#    function onFailure(error) {#}
{#      console.log(error);#}
{#    }#}
{#    function renderButton() {#}
{#      gapi.signin2.render('my-signin2', {#}
{#        'scope': 'profile email',#}
{#        'width': 240,#}
{#        'height': 50,#}
{#        'longtitle': true,#}
{#        'theme': 'dark',#}
{#        'onsuccess': onSuccess,#}
{#        'onfailure': onFailure#}
{#      });#}
{#    }#}
{#  </script>#}


<!--END GOOGLE SIGN IN CODE -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script src="https://apis.google.com/js/platform.js?onload=init"></script>
{#<script src="https://apis.google.com/js/platform.js?onload=renderButton" async defer></script>#}

</html>